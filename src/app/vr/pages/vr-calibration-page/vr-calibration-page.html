<!-- VR Calibration Page Template -->
<!-- Phase 1: AR entry overlay + Welcome panel with BEGIN button -->

<!-- Desktop/Browser Overlay -->
<div class="ar-overlay">
  <div class="ar-overlay__content">
    @if (showCompletePanel()) {
      <!-- Calibration Complete State -->
      <h1>✓ Calibration Complete</h1>
      <p>Your wall is now aligned and ready to use</p>
      <button class="ar-enter-btn ar-enter-btn--success" (click)="goHome()">
        RETURN HOME
      </button>
    } @else {
      <!-- Initial State - Enter AR -->
      <h1>Wall Calibration</h1>
      <p>Put on your headset and click below to begin</p>
      <button class="ar-enter-btn" id="ar-enter-btn">
        ENTER AR
      </button>
    }
  </div>
</div>

<!-- A-Frame Scene -->
<a-scene
  #scene
  xr-mode-ui="XRMode: ar; enterARButton: #ar-enter-btn"
  webxr="optionalFeatures: local-floor, bounded-floor, hand-tracking, anchors;"
  renderer="colorManagement: true;"
  background="color: #1a1a2e"
  fog="type: exponential; color: #1a1a3e; density: 0.05"
>
  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- CALIBRATION LAND - Sky and Floor (hidden in passthrough)-->
  <!-- ═══════════════════════════════════════════════════════ -->
  @if (!passthroughEnabled()) {
    <!-- Sky - dark blue/purple gradient feel -->
    <a-sky color="#1a1a3e"></a-sky>
    
    <!-- Ground plane with subtle color -->
    <a-plane
      id="ground"
      position="0 0 0"
      rotation="-90 0 0"
      width="100"
      height="100"
      color="#2d2d4a"
      material="roughness: 0.9; metalness: 0.1">
    </a-plane>
    
    <!-- Grid lines for spatial reference -->
    <a-entity id="grid-lines" position="0 0.002 0">
      <!-- Center cross - brighter -->
      <a-plane position="0 0 0" rotation="-90 0 0" width="0.02" height="20" color="#4caf50" material="opacity: 0.5"></a-plane>
      <a-plane position="0 0 0" rotation="-90 90 0" width="0.02" height="20" color="#4caf50" material="opacity: 0.5"></a-plane>
      
      <!-- Outer grid lines -->
      <a-plane position="2 0 0" rotation="-90 0 0" width="0.01" height="20" color="#4a4a6a" material="opacity: 0.3"></a-plane>
      <a-plane position="-2 0 0" rotation="-90 0 0" width="0.01" height="20" color="#4a4a6a" material="opacity: 0.3"></a-plane>
      <a-plane position="4 0 0" rotation="-90 0 0" width="0.01" height="20" color="#4a4a6a" material="opacity: 0.3"></a-plane>
      <a-plane position="-4 0 0" rotation="-90 0 0" width="0.01" height="20" color="#4a4a6a" material="opacity: 0.3"></a-plane>
      <a-plane position="0 0 2" rotation="-90 90 0" width="0.01" height="20" color="#4a4a6a" material="opacity: 0.3"></a-plane>
      <a-plane position="0 0 -2" rotation="-90 90 0" width="0.01" height="20" color="#4a4a6a" material="opacity: 0.3"></a-plane>
      <a-plane position="0 0 4" rotation="-90 90 0" width="0.01" height="20" color="#4a4a6a" material="opacity: 0.3"></a-plane>
      <a-plane position="0 0 -4" rotation="-90 90 0" width="0.01" height="20" color="#4a4a6a" material="opacity: 0.3"></a-plane>
    </a-entity>
  }

  <!-- Ambient lighting -->
  <a-entity light="type: ambient; color: #ffffff; intensity: 0.6"></a-entity>
  <a-entity light="type: directional; color: #ffffff; intensity: 0.8" position="0 4 2"></a-entity>

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- WELCOME PANEL                                           -->
  <!-- ═══════════════════════════════════════════════════════ -->
  @if (showWelcomePanel()) {
    <a-entity id="welcome-panel" position="0 1.6 -2">
      <a-plane width="1.6" height="1.0" color="#1a1a2e" material="opacity: 0.95; transparent: true" class="intersectable"></a-plane>
      <a-plane position="0 0.47 0.001" width="1.6" height="0.01" color="#4caf50"></a-plane>
      <a-text value="WALL CALIBRATION" position="0 0.35 0.01" align="center" color="#ffffff" width="1.4" font="mozillavr"></a-text>
      <a-text value="Align your virtual wall with reality" position="0 0.22 0.01" align="center" color="#8b949e" width="1.2"></a-text>
      <a-plane position="0 0.12 0.001" width="1.2" height="0.002" color="#30363d"></a-plane>
      <a-text value="This wizard will guide you through\ncalibrating your climbing wall in 5 steps:" position="0 0.02 0.01" align="center" color="#c9d1d9" width="1.1" baseline="top"></a-text>
      <a-text value="1. Place markers on your real wall\n2. Match markers on 3D model\n3. Auto-align\n4. Fine-tune position\n5. Lock & save" position="-0.5 -0.08 0.01" align="left" color="#8b949e" width="0.9" baseline="top" line-height="60"></a-text>
      
      <!-- BEGIN Button -->
      <a-entity id="start-button" position="0 -0.42 0.01" class="intersectable" vr-button (vr-button-click)="onBeginClick()">
        <a-plane id="start-button-bg" width="0.4" height="0.1" color="#238636" class="intersectable clickable"></a-plane>
        <a-text value="BEGIN" position="0 0.01 0.001" align="center" color="#ffffff" width="0.8"></a-text>
        <a-text value="(point & pull trigger)" position="0 -0.06 0.001" align="center" color="#8b949e" width="0.6"></a-text>
      </a-entity>
      
      <a-text value="Step 0 of 5 · Welcome" position="0 -0.52 0.01" align="center" color="#484f58" width="0.8"></a-text>
    </a-entity>
  }

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- STEP 1 PANEL - Place Real Markers (Passthrough ON)      -->
  <!-- ═══════════════════════════════════════════════════════ -->
  @if (showStep1Panel()) {
    <a-entity id="step1-panel" position="0 1.6 -2">
      <a-plane width="1.2" height="0.7" color="#1a1a2e" material="opacity: 0.9; transparent: true" class="intersectable"></a-plane>
      <a-plane position="0 0.32 0.001" width="1.2" height="0.008" color="#4caf50"></a-plane>
      <a-text value="STEP 1 OF 5" position="0 0.25 0.01" align="center" color="#4caf50" width="0.8"></a-text>
      <a-text value="Mark Your Real Wall" position="0 0.15 0.01" align="center" color="#ffffff" width="1.0" font="mozillavr"></a-text>
      <a-text value="Press A to place a marker at your\ncontroller tip. Place 3 markers on\ncorners of your wall." position="0 0.0 0.01" align="center" color="#c9d1d9" width="1.0" baseline="top"></a-text>
      
      <!-- Marker counter -->
      <a-text [attr.value]="'Markers: ' + markersPlaced() + ' / 3'" position="0 -0.18 0.01" align="center" color="#8b949e" width="0.8"></a-text>
      
      <!-- NEXT Button - only show when 3 markers placed -->
      @if (markersPlaced() >= 3) {
        <a-entity id="step1-next-button" position="0 -0.28 0.01" class="intersectable" vr-button (vr-button-click)="onNextClick()">
          <a-plane id="step1-next-button-bg" width="0.35" height="0.1" color="#238636" class="intersectable clickable"></a-plane>
          <a-text value="NEXT" position="0 0.01 0.001" align="center" color="#ffffff" width="0.7"></a-text>
        </a-entity>
      }
      
      <a-text value="Step 1 of 5 · Real Markers" position="0 -0.38 0.01" align="center" color="#484f58" width="0.8"></a-text>
    </a-entity>
  }

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- STEP 2 PANEL - Place Model Markers (Passthrough OFF)    -->
  <!-- ═══════════════════════════════════════════════════════ -->
  @if (showStep2Panel()) {
    <a-entity id="step2-panel" position="0 1.6 -2">
      <a-plane width="1.2" height="0.7" color="#1a1a2e" material="opacity: 0.9; transparent: true" class="intersectable"></a-plane>
      <a-plane position="0 0.32 0.001" width="1.2" height="0.008" color="#4caf50"></a-plane>
      <a-text value="STEP 2 OF 5" position="0 0.25 0.01" align="center" color="#4caf50" width="0.8"></a-text>
      <a-text value="Mark the 3D Wall" position="0 0.15 0.01" align="center" color="#ffffff" width="1.0" font="mozillavr"></a-text>
      <a-text value="Match the same 3 corners on\nthe virtual wall model" position="0 0.02 0.01" align="center" color="#c9d1d9" width="1.0" baseline="top"></a-text>
      
      <!-- Model marker counter -->
      <a-text [attr.value]="'Model Markers: ' + modelMarkersPlaced() + ' / 3'" position="0 -0.14 0.01" align="center" color="#8b949e" width="0.8"></a-text>
      
      <!-- NEXT Button - only show when 3 model markers placed -->
      @if (modelMarkersPlaced() >= 3) {
        <a-entity id="step2-next-button" position="0 -0.25 0.01" class="intersectable" vr-button (vr-button-click)="onNextClick()">
          <a-plane id="step2-next-button-bg" width="0.35" height="0.1" color="#238636" class="intersectable clickable"></a-plane>
          <a-text value="NEXT" position="0 0.01 0.001" align="center" color="#ffffff" width="0.7"></a-text>
        </a-entity>
      }
      
      <a-text value="Step 2 of 5 · Model Markers" position="0 -0.38 0.01" align="center" color="#484f58" width="0.8"></a-text>
    </a-entity>

    <!-- ═══════════════════════════════════════════════════════ -->
    <!-- WALL MODEL - 3D climbing wall for Step 2 calibration   -->
    <!-- ═══════════════════════════════════════════════════════ -->
    <a-entity 
      id="wall-container" 
      position="0 0 -2"
      wall-manipulator="leftController: #leftController; rightController: #rightController">
      @if (modelPath()) {
        <a-entity
          id="garage"
          [attr.gltf-model]="'url(' + modelPath() + ')'"
          position="0 0 0"
          class="intersectable">
        </a-entity>
      } @else {
        <!-- Placeholder when no model loaded -->
        <a-box 
          position="0 1 0" 
          width="2" 
          height="2.5" 
          depth="0.1" 
          color="#444"
          material="opacity: 0.5; transparent: true">
        </a-box>
        <a-text 
          value="No wall model loaded" 
          position="0 1 0.1" 
          align="center" 
          color="#ff6b6b" 
          width="1.5">
        </a-text>
      }
      
      <!-- Model markers - children of wall-container so they move/scale with it -->
      <a-sphere id="model-marker-1" visible="false" radius="0.015" color="#ff6b6b" material="emissive: #ff6b6b; emissiveIntensity: 0.3" class="model-marker intersectable"></a-sphere>
      <a-sphere id="model-marker-2" visible="false" radius="0.015" color="#4ecdc4" material="emissive: #4ecdc4; emissiveIntensity: 0.3" class="model-marker intersectable"></a-sphere>
      <a-sphere id="model-marker-3" visible="false" radius="0.015" color="#ffe66d" material="emissive: #ffe66d; emissiveIntensity: 0.3" class="model-marker intersectable"></a-sphere>
    </a-entity>
  }

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- STEP 3 PANEL - Alignment (Passthrough ON)               -->
  <!-- ═══════════════════════════════════════════════════════ -->
  @if (showStep3Panel()) {
    <a-entity id="step3-panel" position="0 1.6 -2">
      <a-plane width="1.2" height="0.6" color="#1a1a2e" material="opacity: 0.9; transparent: true" class="intersectable"></a-plane>
      <a-plane position="0 0.27 0.001" width="1.2" height="0.008" color="#4caf50"></a-plane>
      <a-text value="STEP 3 OF 5" position="0 0.2 0.01" align="center" color="#4caf50" width="0.8"></a-text>
      <a-text value="Aligning..." position="0 0.1 0.01" align="center" color="#ffffff" width="1.0" font="mozillavr"></a-text>
      <a-text value="Computing transformation matrix\nto align virtual wall with reality" position="0 -0.02 0.01" align="center" color="#c9d1d9" width="1.0" baseline="top"></a-text>
      
      <!-- NEXT Button -->
      <a-entity id="step3-next-button" position="0 -0.2 0.01" class="intersectable" vr-button (vr-button-click)="onNextClick()">
        <a-plane id="step3-next-button-bg" width="0.35" height="0.1" color="#238636" class="intersectable clickable"></a-plane>
        <a-text value="NEXT" position="0 0.01 0.001" align="center" color="#ffffff" width="0.7"></a-text>
      </a-entity>
      
      <a-text value="Step 3 of 5 · Alignment" position="0 -0.32 0.01" align="center" color="#484f58" width="0.8"></a-text>
    </a-entity>
  }

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- STEP 4 PANEL - Fine-tune (Passthrough ON)               -->
  <!-- ═══════════════════════════════════════════════════════ -->
  @if (showStep4Panel()) {
    <a-entity id="step4-panel" position="0 1.6 -2">
      <a-plane width="1.2" height="0.6" color="#1a1a2e" material="opacity: 0.9; transparent: true" class="intersectable"></a-plane>
      <a-plane position="0 0.27 0.001" width="1.2" height="0.008" color="#4caf50"></a-plane>
      <a-text value="STEP 4 OF 5" position="0 0.2 0.01" align="center" color="#4caf50" width="0.8"></a-text>
      <a-text value="Fine-tune Position" position="0 0.1 0.01" align="center" color="#ffffff" width="1.0" font="mozillavr"></a-text>
      <a-text value="Use controllers to nudge the\nvirtual wall into perfect alignment" position="0 -0.02 0.01" align="center" color="#c9d1d9" width="1.0" baseline="top"></a-text>
      
      <!-- NEXT Button -->
      <a-entity id="step4-next-button" position="0 -0.2 0.01" class="intersectable" vr-button (vr-button-click)="onNextClick()">
        <a-plane id="step4-next-button-bg" width="0.35" height="0.1" color="#238636" class="intersectable clickable"></a-plane>
        <a-text value="SAVE" position="0 0.01 0.001" align="center" color="#ffffff" width="0.7"></a-text>
      </a-entity>
      
      <a-text value="Step 4 of 5 · Fine-tune" position="0 -0.32 0.01" align="center" color="#484f58" width="0.8"></a-text>
    </a-entity>
  }

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- COMPLETE PANEL (Passthrough ON)                         -->
  <!-- ═══════════════════════════════════════════════════════ -->
  @if (showCompletePanel()) {
    <a-entity id="complete-panel" position="0 1.6 -2">
      <a-plane width="1.4" height="0.7" color="#1a1a2e" material="opacity: 0.9; transparent: true" class="intersectable"></a-plane>
      <a-plane position="0 0.32 0.001" width="1.4" height="0.008" color="#4caf50"></a-plane>
      <a-text value="✓ CALIBRATION COMPLETE" position="0 0.2 0.01" align="center" color="#4caf50" width="1.2" font="mozillavr"></a-text>
      <a-text value="Your wall is now aligned!" position="0 0.05 0.01" align="center" color="#c9d1d9" width="1.2"></a-text>
      <a-text value="Exit VR and return to the\nhome page to select your\nwall and start climbing." position="0 -0.12 0.01" align="center" color="#8b949e" width="1.0" baseline="top"></a-text>
      <a-text value="Press the Oculus button to exit" position="0 -0.3 0.01" align="center" color="#484f58" width="0.9"></a-text>
    </a-entity>
  }

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- MARKERS - Ghost and Placed Real Reference Points        -->
  <!-- ═══════════════════════════════════════════════════════ -->
  
  <!-- Ghost marker - follows controller tip with pulsing glow -->
  <a-sphere
    id="ghost-marker"
    visible="false"
    radius="0.008"
    color="#4caf50"
    material="opacity: 0.7; transparent: true; emissive: #4caf50; emissiveIntensity: 0.8"
    animation__scale="property: scale; from: 1 1 1; to: 1.3 1.3 1.3; dur: 400; dir: alternate; loop: true; easing: easeInOutSine">
  </a-sphere>
  
  <!-- Placed markers - raycastable for grab detection -->
  <a-sphere id="real-marker-1" visible="false" radius="0.008" color="#ff6b6b" material="emissive: #ff6b6b; emissiveIntensity: 0.3" class="grabbable clickable"></a-sphere>
  <a-sphere id="real-marker-2" visible="false" radius="0.008" color="#4ecdc4" material="emissive: #4ecdc4; emissiveIntensity: 0.3" class="grabbable clickable"></a-sphere>
  <a-sphere id="real-marker-3" visible="false" radius="0.008" color="#ffe66d" material="emissive: #ffe66d; emissiveIntensity: 0.3" class="grabbable clickable"></a-sphere>

  <!-- ═══════════════════════════════════════════════════════ -->
  <!-- Camera Rig with Controllers                             -->
  <!-- ═══════════════════════════════════════════════════════ -->
  <a-entity id="cameraRig">
    <a-camera id="player"></a-camera>
    
    <!-- Left Controller -->
    <a-entity 
      id="leftController" 
      laser-controls="hand: left"
      raycaster="objects: .clickable; showLine: true; far: 10">
    </a-entity>
    
    <!-- Right Controller with marker-placer and surface-cursor -->
    <a-entity 
      id="rightController" 
      laser-controls="hand: right"
      raycaster="objects: .clickable, .intersectable, .grabbable; showLine: true; far: 10"
      marker-placer="enabled: false"
      surface-cursor="enabled: false; cursorEl: #surface-cursor-visual; targetClass: intersectable">
    </a-entity>
    
    <!-- Surface cursor visual - shows intersection point on wall -->
    <a-box
      id="surface-cursor-visual"
      visible="false"
      width="0.03"
      height="0.03"
      depth="0.03"
      color="#00ff00"
      material="emissive: #00ff00; emissiveIntensity: 0.5">
    </a-box>
  </a-entity>

</a-scene>
